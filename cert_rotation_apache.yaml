---
- name: Deploy matching cert/key to hosts
  hosts: all
  gather_facts: true
  become: true

  vars:
    tls_cert_path: /etc/pki/tls/certs/server.pem
    tls_key_path: /etc/pki/tls/private/server.key

  pre_tasks:
    - name: Sanity check - cert_map exists (from workflow artifacts)
      ansible.builtin.assert:
        that:
          - cert_map is defined
          - cert_map | length > 0
        fail_msg: >
          cert_map is not defined. Ensure the previous workflow job publishes it
          using set_stats (data: { cert_map: ... }).

    - name: Determine match name (use inventory hostname)
      ansible.builtin.set_fact:
        match_name: "{{ inventory_hostname }}"

  tasks:
    - name: Warn if no cert matches this host
      ansible.builtin.debug:
        msg: "WARNING: No certificate in bundle matches {{ match_name }} (skipping)"
      when: match_name not in cert_map

    - name: Install cert/key only when match exists
      block:
        - name: Copy cert
          ansible.builtin.copy:
            src: "{{ cert_map[match_name].cert }}"
            dest: "{{ tls_cert_path }}"
            owner: root
            group: root
            mode: "0644"

        - name: Copy key
          ansible.builtin.copy:
            src: "{{ cert_map[match_name].key }}"
            dest: "{{ tls_key_path }}"
            owner: root
            group: root
            mode: "0600"

        - name: Regenerate cert info json for demo page
          ansible.builtin.command: /usr/local/bin/generate_certinfo.sh
          changed_when: false

        - name: Reload httpd (ignore if not present)
          ansible.builtin.service:
            name: httpd
            state: reloaded
          ignore_errors: true

      when: match_name in cert_map
