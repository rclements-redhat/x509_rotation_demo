<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TLS Certificate Status</title>

<style>
:root{
 --bg0:#0b1220;
 --bg1:#0f1b33;
 --card:#0f1f3d;
 --muted:#9fb2d6;
 --text:#eaf0ff;
 --accent:#6ee7ff;
 --good:#3ddc97;
 --warn:#ffd166;
 --bad:#ff5c7a;
 --border:rgba(255,255,255,.10);
 --shadow:0 12px 40px rgba(0,0,0,.35);
 --mono:ui-monospace,Menlo,Consolas,monospace;
 --sans:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
}

*{box-sizing:border-box}

body{
 margin:0;
 font-family:var(--sans);
 color:var(--text);
 background:
 radial-gradient(1200px 700px at 20% 10%, rgba(110,231,255,.18), transparent 60%),
 radial-gradient(900px 600px at 80% 20%, rgba(61,220,151,.12), transparent 55%),
 linear-gradient(180deg,var(--bg0),var(--bg1));
 min-height:100vh;
 display:flex;
 align-items:center;
 justify-content:center;
 padding:24px;
}

.wrap{width:min(1100px,100%)}

.header{
 display:flex;
 justify-content:space-between;
 align-items:flex-end;
 margin-bottom:10px;
}

h1{
 margin:0;
 font-size:28px;
}

.subtitle{
 color:var(--muted);
 font-size:14px;
}

/* BIG SERVER BANNER */
.serverBanner{
 margin:14px 0 20px;
 padding:22px;
 border-radius:18px;
 background:linear-gradient(135deg,rgba(110,231,255,.15),rgba(61,220,151,.12));
 border:1px solid var(--border);
 box-shadow:var(--shadow);
}

.serverLabel{
 font-size:12px;
 letter-spacing:.15em;
 text-transform:uppercase;
 color:var(--muted);
 margin-bottom:6px;
}

.serverName{
 font-size:clamp(36px,6vw,72px);
 font-weight:800;
 color:var(--accent);
 letter-spacing:-.02em;
}

.serverMeta{
 margin-top:10px;
 font-size:13px;
 color:var(--muted);
}
.serverMeta span{
 color:#dbe7ff;
 font-family:var(--mono);
}

.pill{
 display:inline-flex;
 align-items:center;
 gap:8px;
 padding:8px 12px;
 border:1px solid var(--border);
 background:rgba(255,255,255,.05);
 border-radius:999px;
 font-size:13px;
 color:var(--muted);
}

.dot{
 width:10px;height:10px;border-radius:50%;
 background:var(--warn);
}

.grid{
 display:grid;
 grid-template-columns:1.25fr .75fr;
 gap:16px;
}

.card{
 background:rgba(15,31,61,.78);
 border:1px solid var(--border);
 border-radius:18px;
 box-shadow:var(--shadow);
 overflow:hidden;
}

.card .top{
 padding:18px;
 border-bottom:1px solid var(--border);
 display:flex;
 justify-content:space-between;
}

.card .body{padding:18px}

.kv{
 display:grid;
 grid-template-columns:170px 1fr;
 gap:10px 14px;
}

.k{
 color:var(--muted);
 font-size:12px;
 text-transform:uppercase;
 letter-spacing:.08em;
}

.v{
 font-size:14px;
 word-break:break-word;
}

.mono{font-family:var(--mono)}

.footer{
 margin-top:16px;
 font-size:12px;
 color:var(--muted);
 display:flex;
 justify-content:space-between;
}

.statusStrong{font-weight:700}
.ok{color:var(--good)}
.warn{color:var(--warn)}
.bad{color:var(--bad)}

.btn{
 cursor:pointer;
 border:1px solid var(--border);
 background:rgba(255,255,255,.06);
 color:#eaf0ff;
 padding:8px 12px;
 border-radius:12px;
 font-size:13px;
}
</style>
</head>

<body>
<div class="wrap">

<div class="header">
 <div>
  <h1>TLS Certificate Status</h1>
  <div class="subtitle">Live certificate + backend node</div>
 </div>
 <div class="pill">
  <span class="dot" id="statusDot"></span>
  <span id="statusText">Checking…</span>
 </div>
</div>

<!-- BIG SERVER NAME -->
<div class="serverBanner">
 <div class="serverLabel">Connected To Server</div>
 <div class="serverName" id="serverName">{{ inventory_hostname }}</div>
 <div class="serverMeta">Cert CN: <span id="certCNInline">…</span></div>
</div>

<div class="grid">

<section class="card">
<div class="top">
 <h2>Certificate Overview</h2>
 <span id="badgeCN">CN: …</span>
</div>

<div class="body">
<dl class="kv">

<div class="k">Subject</div><div class="v mono" id="subject">…</div>
<div class="k">Issuer</div><div class="v mono" id="issuer">…</div>
<div class="k">Serial</div><div class="v mono" id="serial">…</div>
<div class="k">Valid From</div><div class="v" id="notBefore">…</div>
<div class="k">Valid Until</div><div class="v" id="notAfter">…</div>
<div class="k">Days Remaining</div><div class="v" id="daysLeft">…</div>
<div class="k">SHA-256</div><div class="v mono" id="fpSha256">…</div>

</dl>

<div class="footer">
<div>Status: <span class="statusStrong" id="statusLabel">…</span></div>
<div>
<button class="btn" id="refreshBtn">Refresh</button>
</div>
</div>

</div>
</section>

<aside class="card">
<div class="top"><h2>Endpoint</h2></div>
<div class="body">
<dl class="kv" style="grid-template-columns:110px 1fr;">
<div class="k">Host</div><div class="v mono" id="host">…</div>
<div class="k">Fetched</div><div class="v" id="fetchedAt">…</div>
</dl>
</div>
</aside>

</div>
</div>

<script>
const CERTINFO_URL="/certinfo.json";
const el=id=>document.getElementById(id);

function fmtDate(x){ if(!x) return "—"; return new Date(x).toLocaleString(); }
function daysBetween(a,b){ return Math.floor((b-a)/(86400000)); }

function setStatus(days){
    const dot = el("statusDot");
    const txt = el("statusText");
    const lbl = el("statusLabel");

    let cls="warn", msg="Expiring soon";

    if (days >= 30){
        cls="ok";
        msg="Healthy";
    }
    else if (days < 7){
        cls="bad";
        msg="Critical";
    }

    // text
    txt.textContent = `${msg} • ${days} days`;
    lbl.textContent = msg;
    lbl.className = "statusStrong " + cls;

    // DOT COLOR FIX
    if (cls === "ok"){
        dot.style.background = "var(--good)";
        dot.style.boxShadow = "0 0 0 4px rgba(61,220,151,.25)";
    }
    else if (cls === "bad"){
        dot.style.background = "var(--bad)";
        dot.style.boxShadow = "0 0 0 4px rgba(255,92,122,.25)";
    }
    else{
        dot.style.background = "var(--warn)";
        dot.style.boxShadow = "0 0 0 4px rgba(255,209,102,.25)";
    }
}


async function load(){
 el("host").textContent=location.hostname;
 el("fetchedAt").textContent=new Date().toLocaleString();

 const res=await fetch(CERTINFO_URL,{cache:"no-store"});
 const d=await res.json();

 const cn=d.common_name ||
  (d.subject||"").match(/CN\s*=\s*([^,\/]+)/)?.[1] ||
  "unknown";

 // ===== SERVER NAME PRIORITY =====
 // 1) backend provided hostname (best)
 // 2) browser hostname fallback
 const realServer = d.server_hostname || location.hostname || "unknown";

 el("certCNInline").textContent = cn;
 el("badgeCN").textContent="CN: "+cn;

 el("subject").textContent=d.subject||"—";
 el("issuer").textContent=d.issuer||"—";
 el("serial").textContent=d.serial||"—";
 el("notBefore").textContent=fmtDate(d.not_before);
 el("notAfter").textContent=fmtDate(d.not_after);
 el("fpSha256").textContent=d.fingerprint_sha256||"—";

 let days=0;
 if(d.not_after){
  days=daysBetween(new Date(), new Date(d.not_after));
 }
 el("daysLeft").textContent=days;
 setStatus(days);

 el("refreshBtn").onclick=()=>location.reload();
}

load().catch(e=>{
 el("serverName").textContent="Unable to load";
});
</script>

</body>
</html>
